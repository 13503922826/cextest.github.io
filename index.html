<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>币安Alpha记账日历</title>
    <!-- 使用更可靠的CDN链接 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        /* 添加本地字体以确保兼容性 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
        }
        .calendar-day:hover {
            transform: scale(1.05);
            transition: all 0.2s ease-in-out;
        }
        .positive {
            color: #10B981; /* green-500 */
        }
        .negative {
            color: #EF4444; /* red-500 */
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .fade-in {
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        
        /* 添加额外的兼容性样式 */
        .container {
            width: 100%;
            padding-right: 15px;
            padding-left: 15px;
            margin-right: auto;
            margin-left: auto;
        }
        @media (min-width: 576px) {
            .container {
                max-width: 540px;
            }
        }
        @media (min-width: 768px) {
            .container {
                max-width: 720px;
            }
        }
        @media (min-width: 992px) {
            .container {
                max-width: 960px;
            }
        }
        @media (min-width: 1200px) {
            .container {
                max-width: 1140px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-md py-4 px-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">币安Alpha记账日历</h1>
        </div>
        <div class="flex items-center space-x-4">
            <!-- User Selector -->
            <div class="flex items-center space-x-2 bg-gray-100 rounded-full px-4 py-2">
                <i class="fas fa-user text-gray-600"></i>
                <select id="userSelector" class="bg-transparent border-none focus:ring-0" onchange="switchUser(this.value)">
                    <!-- Users will be populated here -->
                </select>
                <button onclick="showEditUserModal()" class="text-gray-600 hover:text-gray-900">
                    <i class="fas fa-edit text-xl"></i>
                </button>
                <button onclick="showDeleteUserModal()" class="text-gray-600 hover:text-gray-900">
                    <i class="fas fa-trash text-xl"></i>
                </button>
                <button onclick="showAddUserModal()" class="text-gray-600 hover:text-gray-900">
                    <i class="fas fa-plus-circle text-xl"></i>
                </button>
            </div>
            <button onclick="exportData()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                <i class="fas fa-file-export"></i> 导出
            </button>
            <button onclick="showImportModal()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                <i class="fas fa-file-import"></i> 导入
            </button>
        </div>
    </header>

    <!-- Summary Section -->
    <section class="container mx-auto mt-6 px-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">月累计收入 (USDT)</h3>
                <p id="monthlyIncome" class="text-xl font-semibold">0.00</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">月项目总数</h3>
                <p id="monthlyProjects" class="text-xl font-semibold">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">月利润 (USDT)</h3>
                <p id="monthlyProfit" class="text-xl font-semibold">0.00</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">预计明日积分</h3>
                <p id="predictedPoints" class="text-xl font-semibold">0</p>
                <button onclick="refreshPointsPrediction()" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                    刷新预测
                </button>
            </div>
        </div>
        
        <!-- 新增的用户总览统计 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 rounded-lg shadow">
                <h3 class="text-gray-100 text-sm">用户总收益 (USDT)</h3>
                <p id="totalProfit" class="text-2xl font-bold">0.00</p>
            </div>
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 rounded-lg shadow">
                <h3 class="text-gray-100 text-sm">领取项目总数</h3>
                <p id="totalProjects" class="text-2xl font-bold">0</p>
            </div>
            <div class="bg-gradient-to-r from-red-500 to-rose-600 text-white p-4 rounded-lg shadow">
                <h3 class="text-gray-100 text-sm">总消耗 (USDT)</h3>
                <p id="totalExpense" class="text-2xl font-bold">0.00</p>
            </div>
        </div>
    </section>

    <!-- Calendar Navigation -->
    <section class="container mx-auto mt-6 px-4 flex justify-between items-center">
        <button onclick="prevMonth()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">
            <i class="fas fa-chevron-left"></i> 上月
        </button>
        <h2 id="currentMonthYear" class="text-xl font-bold">2025年10月</h2>
        <button onclick="nextMonth()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">
            下月 <i class="fas fa-chevron-right"></i>
        </button>
    </section>

    <!-- Calendar Grid -->
    <section class="container mx-auto mt-6 px-4">
        <div class="grid grid-cols-7 gap-1 mb-2">
            <div class="text-center font-bold py-2">日</div>
            <div class="text-center font-bold py-2">一</div>
            <div class="text-center font-bold py-2">二</div>
            <div class="text-center font-bold py-2">三</div>
            <div class="text-center font-bold py-2">四</div>
            <div class="text-center font-bold py-2">五</div>
            <div class="text-center font-bold py-2">六</div>
        </div>
        <div id="calendarGrid" class="grid grid-cols-7 gap-1">
            <!-- Calendar days will be populated here -->
        </div>
    </section>

    <!-- Entry Modal -->
    <div id="entryModal" class="modal fade-in">
        <div class="modal-content">
            <span class="close" onclick="closeEntryModal()">&times;</span>
            <h2 class="text-xl font-bold mb-4">编辑记账条目</h2>
            <form id="entryForm">
                <input type="hidden" id="entryDate">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="pointsEarnedToday">
                            今日交易获取积分
                        </label>
                        <select id="pointsEarnedToday" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">请选择挡位</option>
                            <option value="6">64 USDT (6分)</option>
                            <option value="7">128 USDT (7分)</option>
                            <option value="8">256 USDT (8分)</option>
                            <option value="9">512 USDT (9分)</option>
                            <option value="10">1024 USDT (10分)</option>
                            <option value="11">2048 USDT (11分)</option>
                            <option value="12">4096 USDT (12分)</option>
                            <option value="13">8192 USDT (13分)</option>
                            <option value="14">16384 USDT (14分)</option>
                            <option value="15">32768 USDT (15分)</option>
                            <option value="16">65536 USDT (16分)</option>
                            <option value="17">131072 USDT (17分)</option>
                            <option value="18">262144 USDT (18分)</option>
                            <option value="19">524288 USDT (19分)</option>
                            <option value="20">1048576 USDT (20分)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="balancePointsToday">
                            今日余额获取积分
                        </label>
                        <select id="balancePointsToday" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">请选择挡位</option>
                            <option value="1">100 USDT (1分)</option>
                            <option value="2">1000 USDT (2分)</option>
                            <option value="3">10000 USDT (3分)</option>
                            <option value="4">100000 USDT (4分)</option>
                            <option value="5">1000000 USDT (5分)</option>
                            <option value="6">10000000 USDT (6分)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="extraPointsToday">
                            今日额外积分
                        </label>
                        <input type="number" step="any" id="extraPointsToday" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="pointsConsumedToday">
                            今日消耗积分
                        </label>
                        <input type="number" step="any" id="pointsConsumedToday" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="projectsClaimedToday">
                            今日领取项目数
                        </label>
                        <input type="number" id="projectsClaimedToday" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="dailyExpense">
                            今日支出 (USDT)
                        </label>
                        <input type="number" step="0.01" id="dailyExpense" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="dailyIncome">
                            今日收入 (USDT)
                        </label>
                        <input type="number" step="0.01" id="dailyIncome" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="notes">
                        备注
                    </label>
                    <textarea id="notes" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="3"></textarea>
                </div>
                <div class="flex items-center justify-between">
                    <button type="button" onclick="deleteEntry()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        删除条目
                    </button>
                    <div>
                        <button type="button" onclick="closeEntryModal()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2">
                            取消
                        </button>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            保存
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal fade-in">
        <div class="modal-content">
            <span class="close" onclick="closeAddUserModal()">&times;</span>
            <h2 class="text-xl font-bold mb-4">添加新用户</h2>
            <form id="addUserForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="newUserName">
                        用户名
                    </label>
                    <input type="text" id="newUserName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="flex items-center justify-end">
                    <button type="button" onclick="closeAddUserModal()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2">
                        取消
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        添加
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal fade-in">
        <div class="modal-content">
            <span class="close" onclick="closeEditUserModal()">&times;</span>
            <h2 class="text-xl font-bold mb-4">编辑用户</h2>
            <form id="editUserForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="editUserName">
                        用户名
                    </label>
                    <input type="text" id="editUserName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <input type="hidden" id="editUserId">
                </div>
                <div class="flex items-center justify-end">
                    <button type="button" onclick="closeEditUserModal()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2">
                        取消
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete User Modal -->
    <div id="deleteUserModal" class="modal fade-in">
        <div class="modal-content">
            <span class="close" onclick="closeDeleteUserModal()">&times;</span>
            <h2 class="text-xl font-bold mb-4">删除用户</h2>
            <p class="mb-4">确定要删除用户 "<span id="deleteUserName"></span>" 吗？此操作无法撤销。</p>
            <input type="hidden" id="deleteUserId">
            <div class="flex items-center justify-end">
                <button type="button" onclick="closeDeleteUserModal()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2">
                    取消
                </button>
                <button onclick="confirmDeleteUser()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    删除
                </button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal fade-in">
        <div class="modal-content">
            <span class="close" onclick="closeImportModal()">&times;</span>
            <h2 class="text-xl font-bold mb-4">导入数据</h2>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="importFile">
                    选择JSON文件
                </label>
                <input type="file" id="importFile" accept=".json" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="flex items-center justify-end">
                <button type="button" onclick="closeImportModal()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2">
                    取消
                </button>
                <button onclick="importData()" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    导入
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0-11
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('accountingUsers')) || [];
        let accountingData = {};

        // Initialize the app
        window.onload = function() {
            // Load users
            loadUsers();
            
            // Set current user if none selected
            if (!currentUser && users.length > 0) {
                currentUser = users[0].id;
            }
            
            // Load data for current user
            loadData();
            
            // Render calendar
            renderCalendar(currentYear, currentMonth);
            
            // Refresh points prediction
            refreshPointsPrediction();
            
            // Setup form submission handlers
            document.getElementById('entryForm').addEventListener('submit', saveEntry);
            document.getElementById('addUserForm').addEventListener('submit', addUser);
            document.getElementById('editUserForm').addEventListener('submit', editUser);
        };

        // User Management Functions
        function loadUsers() {
            const selector = document.getElementById('userSelector');
            selector.innerHTML = '';
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                selector.appendChild(option);
            });
            
            // Select current user
            if (currentUser) {
                selector.value = currentUser;
            }
        }

        function switchUser(userId) {
            currentUser = userId;
            loadData();
            renderCalendar(currentYear, currentMonth);
            refreshPointsPrediction();
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
            document.getElementById('newUserName').value = '';
        }

        function showEditUserModal() {
            if (!currentUser) return;
            
            const user = users.find(u => u.id === currentUser);
            if (user) {
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUserName').value = user.name;
                document.getElementById('editUserModal').style.display = 'block';
            }
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
            document.getElementById('editUserName').value = '';
            document.getElementById('editUserId').value = '';
        }

        function showDeleteUserModal() {
            if (!currentUser) return;
            
            const user = users.find(u => u.id === currentUser);
            if (user) {
                document.getElementById('deleteUserId').value = user.id;
                document.getElementById('deleteUserName').textContent = user.name;
                document.getElementById('deleteUserModal').style.display = 'block';
            }
        }

        function closeDeleteUserModal() {
            document.getElementById('deleteUserModal').style.display = 'none';
            document.getElementById('deleteUserId').value = '';
        }

        function addUser(e) {
            e.preventDefault();
            const name = document.getElementById('newUserName').value.trim();
            
            if (name) {
                const newUser = {
                    id: 'user_' + Date.now(),
                    name: name
                };
                
                users.push(newUser);
                localStorage.setItem('accountingUsers', JSON.stringify(users));
                
                // Switch to new user
                currentUser = newUser.id;
                loadUsers();
                loadData();
                renderCalendar(currentYear, currentMonth);
                refreshPointsPrediction();
                
                closeAddUserModal();
            }
        }

        function editUser(e) {
            e.preventDefault();
            const userId = document.getElementById('editUserId').value;
            const newName = document.getElementById('editUserName').value.trim();
            
            if (userId && newName) {
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex].name = newName;
                    localStorage.setItem('accountingUsers', JSON.stringify(users));
                    loadUsers();
                    closeEditUserModal();
                }
            }
        }

        function confirmDeleteUser() {
            const userId = document.getElementById('deleteUserId').value;
            
            if (userId) {
                // Confirm deletion
                if (confirm('确定要删除此用户及其所有数据吗？此操作无法撤销。')) {
                    // Remove user from users array
                    users = users.filter(u => u.id !== userId);
                    localStorage.setItem('accountingUsers', JSON.stringify(users));
                    
                    // Delete user's data
                    localStorage.removeItem(`accountingData_${userId}`);
                    
                    // Switch to another user if available
                    if (users.length > 0) {
                        currentUser = users[0].id;
                    } else {
                        currentUser = null;
                    }
                    
                    loadUsers();
                    loadData();
                    renderCalendar(currentYear, currentMonth);
                    refreshPointsPrediction();
                    closeDeleteUserModal();
                }
            }
        }

        // Data Management Functions
        function loadData() {
            if (!currentUser) return;
            
            const storedData = localStorage.getItem(`accountingData_${currentUser}`);
            accountingData = storedData ? JSON.parse(storedData) : {};
        }

        function saveData() {
            if (!currentUser) return;
            
            localStorage.setItem(`accountingData_${currentUser}`, JSON.stringify(accountingData));
            updateSummary();
        }

        // Calendar Navigation Functions
        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentYear, currentMonth);
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentYear, currentMonth);
        }

        // Calendar Rendering Functions
        function renderCalendar(year, month) {
            // Update header
            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            document.getElementById('currentMonthYear').textContent = `${year}年 ${monthNames[month]}`;
            
            // Get first day of month and last day
            const firstDay = new Date(year, month, 1).getDay(); // 0-6 (Sunday-Saturday)
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Clear calendar grid
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('p-2', 'h-24');
                calendarGrid.appendChild(emptyCell);
            }
            
            // Add cells for each day of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = accountingData[dateStr] || {};
                
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day', 'bg-white', 'p-2', 'rounded', 'shadow', 'cursor-pointer', 'h-24', 'flex', 'flex-col');
                dayCell.dataset.date = dateStr;
                
                // Day number
                const dayNumber = document.createElement('div');
                dayNumber.classList.add('font-bold', 'text-gray-700');
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);
                
                // Income - Expense
                const income = parseFloat(dayData.dailyIncome) || 0;
                const expense = parseFloat(dayData.dailyExpense) || 0;
                const profit = income - expense;
                
                if (profit !== 0) {
                    const profitElement = document.createElement('div');
                    profitElement.classList.add('text-xs', 'mt-1');
                    profitElement.textContent = `${profit >= 0 ? '+' : ''}${profit.toFixed(2)} USDT`;
                    profitElement.classList.add(profit >= 0 ? 'positive' : 'negative');
                    dayCell.appendChild(profitElement);
                }
                
                // Points calculation (separate display for earned and consumed)
                const earnedPoints = (parseFloat(dayData.pointsEarnedToday) || 0) +
                                    (parseFloat(dayData.balancePointsToday) || 0) +
                                    (parseFloat(dayData.extraPointsToday) || 0);
                const consumedPoints = parseFloat(dayData.pointsConsumedToday) || 0;
                
                // Display earned points in green
                if (earnedPoints > 0) {
                    const earnedElement = document.createElement('div');
                    earnedElement.classList.add('text-xs', 'mt-1', 'positive');
                    earnedElement.textContent = `+${earnedPoints} 分`;
                    dayCell.appendChild(earnedElement);
                }
                
                // Display consumed points in red
                if (consumedPoints > 0) {
                    const consumedElement = document.createElement('div');
                    consumedElement.classList.add('text-xs', 'mt-1', 'negative');
                    consumedElement.textContent = `-${consumedPoints} 分`;
                    dayCell.appendChild(consumedElement);
                }
                
                // Click event to open entry modal
                dayCell.addEventListener('click', () => openEntryModal(dateStr));
                
                calendarGrid.appendChild(dayCell);
            }
            
            // Update summary
            updateSummary();
        }

        // Entry Modal Functions
        function openEntryModal(dateStr) {
            const dayData = accountingData[dateStr] || {};
            
            document.getElementById('entryDate').value = dateStr;
            document.getElementById('pointsEarnedToday').value = dayData.pointsEarnedToday || '';
            document.getElementById('balancePointsToday').value = dayData.balancePointsToday || '';
            document.getElementById('extraPointsToday').value = dayData.extraPointsToday || '';
            document.getElementById('pointsConsumedToday').value = dayData.pointsConsumedToday || '';
            document.getElementById('projectsClaimedToday').value = dayData.projectsClaimedToday || '';
            document.getElementById('dailyExpense').value = dayData.dailyExpense || '';
            document.getElementById('dailyIncome').value = dayData.dailyIncome || '';
            document.getElementById('notes').value = dayData.notes || '';
            
            document.getElementById('entryModal').style.display = 'block';
        }

        function closeEntryModal() {
            document.getElementById('entryModal').style.display = 'none';
        }

        function saveEntry(e) {
            e.preventDefault();
            const dateStr = document.getElementById('entryDate').value;
            
            if (!dateStr) return;
            
            // Collect form data
            const formData = {
                pointsEarnedToday: document.getElementById('pointsEarnedToday').value,
                balancePointsToday: document.getElementById('balancePointsToday').value,
                extraPointsToday: document.getElementById('extraPointsToday').value,
                pointsConsumedToday: document.getElementById('pointsConsumedToday').value,
                projectsClaimedToday: document.getElementById('projectsClaimedToday').value,
                dailyExpense: document.getElementById('dailyExpense').value,
                dailyIncome: document.getElementById('dailyIncome').value,
                notes: document.getElementById('notes').value
            };
            
            // Save to accountingData
            accountingData[dateStr] = formData;
            
            // Save to localStorage
            saveData();
            
            // Re-render calendar
            renderCalendar(currentYear, currentMonth);
            
            // Refresh points prediction
            refreshPointsPrediction();
            
            // Close modal
            closeEntryModal();
        }

        function deleteEntry() {
            const dateStr = document.getElementById('entryDate').value;
            
            if (!dateStr) return;
            
            if (confirm('确定要删除这一天的记账记录吗？')) {
                delete accountingData[dateStr];
                saveData();
                renderCalendar(currentYear, currentMonth);
                closeEntryModal();
            }
        }

        // Summary Functions
        function updateSummary() {
            if (!currentUser) return;
            
            // Calculate monthly totals
            let monthlyIncome = 0;
            let monthlyProjects = 0;
            let monthlyProfit = 0;
            
            // Iterate through all dates in accountingData
            Object.keys(accountingData).forEach(dateStr => {
                // Check if date is in current month and year
                const date = new Date(dateStr);
                if (date.getFullYear() === currentYear && date.getMonth() === currentMonth) {
                    const data = accountingData[dateStr];
                    const income = parseFloat(data.dailyIncome) || 0;
                    const expense = parseFloat(data.dailyExpense) || 0;
                    const projects = parseInt(data.projectsClaimedToday) || 0;
                    
                    monthlyIncome += income;
                    monthlyProjects += projects;
                    monthlyProfit += (income - expense);
                }
            });
            
            // Update DOM elements
            document.getElementById('monthlyIncome').textContent = monthlyIncome.toFixed(2);
            document.getElementById('monthlyProjects').textContent = monthlyProjects;
            document.getElementById('monthlyProfit').textContent = monthlyProfit.toFixed(2);
            document.getElementById('monthlyProfit').className = 
                'text-xl font-semibold ' + (monthlyProfit >= 0 ? 'positive' : 'negative');
            
            // Calculate user's total statistics
            let totalProfit = 0;
            let totalProjects = 0;
            let totalExpense = 0;
            
            // Iterate through all dates in accountingData for total statistics
            Object.keys(accountingData).forEach(dateStr => {
                const data = accountingData[dateStr];
                const income = parseFloat(data.dailyIncome) || 0;
                const expense = parseFloat(data.dailyExpense) || 0;
                const projects = parseInt(data.projectsClaimedToday) || 0;
                
                // Calculate profit for this day (income - expense)
                const dayProfit = income - expense;
                
                totalProfit += dayProfit;
                totalProjects += projects;
                totalExpense += expense;
            });
            
            // Update total statistics DOM elements
            document.getElementById('totalProfit').textContent = totalProfit.toFixed(2);
            document.getElementById('totalProjects').textContent = totalProjects;
            document.getElementById('totalExpense').textContent = totalExpense.toFixed(2);
        }

        // Points Prediction Functions
        function refreshPointsPrediction() {
            if (!currentUser) return;
            
            // Calculate points for last 15 days (excluding today)
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 15);
            
            let totalPoints = 0;
            
            // Iterate through all dates in accountingData
            Object.keys(accountingData).forEach(dateStr => {
                const date = new Date(dateStr);
                
                // Check if date is within the last 15 days and before today
                if (date >= startDate && date < today) {
                    const data = accountingData[dateStr];
                    const earnedPoints = (parseFloat(data.pointsEarnedToday) || 0) +
                                        (parseFloat(data.balancePointsToday) || 0) +
                                        (parseFloat(data.extraPointsToday) || 0);
                    const consumedPoints = parseFloat(data.pointsConsumedToday) || 0;
                    
                    totalPoints += (earnedPoints - consumedPoints);
                }
            });
            
            // Update DOM element
            document.getElementById('predictedPoints').textContent = totalPoints.toFixed(2);
            document.getElementById('predictedPoints').className = 
                'text-xl font-semibold ' + (totalPoints >= 0 ? 'positive' : 'negative');
        }

        // Import/Export Functions
        function exportData() {
            if (!currentUser) {
                alert('请先选择一个用户');
                return;
            }
            
            const dataToExport = {
                user: users.find(u => u.id === currentUser),
                data: accountingData
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `accounting-data-${currentUser}.json`;
            link.click();
        }

        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importFile').value = '';
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择一个文件');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // If it contains user info, add the user
                    if (importedData.user) {
                        // Check if user already exists
                        const existingUser = users.find(u => u.id === importedData.user.id);
                        
                        if (!existingUser) {
                            users.push(importedData.user);
                            localStorage.setItem('accountingUsers', JSON.stringify(users));
                        }
                        
                        // Switch to imported user
                        currentUser = importedData.user.id;
                        loadUsers();
                    }
                    
                    // Import data
                    if (importedData.data) {
                        accountingData = importedData.data;
                        saveData();
                        renderCalendar(currentYear, currentMonth);
                        refreshPointsPrediction();
                    }
                    
                    closeImportModal();
                    alert('数据导入成功！');
                } catch (error) {
                    console.error('导入失败:', error);
                    alert('导入失败：文件格式不正确');
                }
            };
            
            reader.readAsText(file);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const entryModal = document.getElementById('entryModal');
            const addUserModal = document.getElementById('addUserModal');
            const importModal = document.getElementById('importModal');
            
            if (event.target === entryModal) {
                closeEntryModal();
            }
            
            if (event.target === addUserModal) {
                closeAddUserModal();
            }
            
            if (event.target === importModal) {
                closeImportModal();
            }
        };
    </script>
</body>
</html>
